name: Shell Syntax Check

description: |
  Validates shell completion files and executable shell scripts installed
  by a package, using each shell's built-in parse-only mode.

  When the optional "files" input is specified (space-separated list of
  paths), only those files are checked. Otherwise, all shell files
  installed by the package are found automatically.

  Completion files are detected by install location (shebangs not required,
  these files are sourced rather than executed directly):
    usr/share/bash-completion/completions/  → bash --norc -n
    usr/share/zsh/site-functions/           → zsh -n
    usr/share/fish/vendor_completions.d/    → fish --no-execute

  Executable shell scripts in usr/bin, usr/sbin, and usr/libexec are
  detected by their shebang (#!) line:
    #!/bin/bash, #!/usr/bin/env bash        → bash --norc -n
    #!/bin/sh, #!/bin/dash, #!/usr/bin/env sh|dash|ash  → sh -n
    #!/bin/busybox sh|ash, #!/usr/bin/busybox sh|ash    → sh -n
    #!/bin/zsh, #!/usr/bin/env zsh          → zsh -n
    #!/usr/bin/env fish                     → fish --no-execute

  Exits with an error if no shell files are found at all, or if any
  file fails its syntax check.

inputs:
  files:
    description: |
      Optional space-separated list of files to check. When specified, only
      these files are checked. When omitted, all shell completion files and
      executable shell scripts installed by the package are found
      automatically.
    required: false
    default: ""

needs:
  packages:
    - bash
    - fish
    - zsh

pipeline:
  - name: Check shell completion and script syntax
    runs: |
      set -euo pipefail
      total=0

      # check_by_shebang: read shebang, pick checker, run it.
      # Returns 0 if the file was recognised and checked, 1 if skipped.
      check_by_shebang() {
        local f="$1" shebang
        shebang=$(head -1 "$f" 2>/dev/null) || return 1
        case "$shebang" in
          "#!/bin/bash"*|"#!/usr/bin/bash"*|"#!/usr/bin/env bash"*)
            bash --norc -n "$f" ;;
          "#!/bin/sh"*|"#!/usr/bin/env sh"*|"#!/bin/dash"*|"#!/usr/bin/env dash"*|"#!/usr/bin/ash"*|"#!/usr/bin/env ash"*|"#!/bin/busybox"*|"#!/usr/bin/busybox"*)
            sh -n "$f" ;;
          "#!/bin/zsh"*|"#!/usr/bin/zsh"*|"#!/usr/bin/env zsh"*)
            zsh -n "$f" ;;
          "#!/usr/bin/fish"*|"#!/usr/bin/env fish"*)
            fish --no-execute "$f" ;;
          *) return 1 ;;
        esac
        return 0
      }

      # check_file: try location-based detection first, then shebang.
      # Increments $total if the file is recognised as a shell file.
      check_file() {
        local f="$1"
        case "$f" in
          /usr/share/bash-completion/completions/*)
            bash --norc -n "$f"
            total=$((total + 1)) ;;
          /usr/share/zsh/site-functions/*)
            zsh -n "$f"
            total=$((total + 1)) ;;
          /usr/share/fish/vendor_completions.d/*.fish)
            fish --no-execute "$f"
            total=$((total + 1)) ;;
          *)
            if check_by_shebang "$f"; then
              total=$((total + 1))
            fi ;;
        esac
      }

      files="${{inputs.files}}"

      if [ -n "$files" ]; then
        # Explicit file list: check only the specified files.
        for f in $files; do
          check_file "$f"
        done
      else
        # Auto-detection: find all shell files installed by the package.

        # Bash completion files (location-based, no shebang required)
        while IFS= read -r -d '' f; do
          bash --norc -n "$f"
          total=$((total + 1))
        done < <(find /usr/share/bash-completion/completions -type f ! -name '.*' -print0 2>/dev/null)

        # Zsh completion files (location-based)
        while IFS= read -r -d '' f; do
          zsh -n "$f"
          total=$((total + 1))
        done < <(find /usr/share/zsh/site-functions -type f -print0 2>/dev/null)

        # Fish completion files (location-based)
        while IFS= read -r -d '' f; do
          fish --no-execute "$f"
          total=$((total + 1))
        done < <(find /usr/share/fish/vendor_completions.d -type f -name '*.fish' -print0 2>/dev/null)

        # Executable shell scripts (shebang-based), skips binaries automatically
        while IFS= read -r -d '' f; do
          if check_by_shebang "$f"; then
            total=$((total + 1))
          fi
        done < <(find /usr/bin /usr/sbin /usr/libexec -type f -executable -print0 2>/dev/null)
      fi

      if [ "$total" -eq 0 ]; then
        echo "ERROR: no shell scripts or completion files found to check"
        exit 1
      fi

      echo "Shell syntax check passed: $total file(s) checked"
